name: Build DuckDB static bundle on Amazon Linux 2023

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    strategy:
      matrix:
        include:
          - arch: arm64-aws-lambda
            runner: 'ubuntu-24.04-arm' 
            platform: arm64-linux
            DUCKDB_PLATFORM: linux_arm64
            CXXFLAGS: "-march=armv8.2-a+crypto+fp16+dotprod -mtune=neoverse-n1 -moutline-atomics -O3 -flto=auto -ffast-math -funroll-loops -fomit-frame-pointer -DNDEBUG"
            CFLAGS: "-march=armv8.2-a+crypto+fp16+dotprod -mtune=neoverse-n1 -moutline-atomics -O3 -flto=auto -DNDEBUG"
          - arch: m1-linux
            runner: 'ubuntu-24.04-arm' 
            platform: arm64-linux
            DUCKDB_PLATFORM: linux_arm64
            CXXFLAGS: "-march=armv8.4-a+crypto+fp16+dotprod+rcpc+sha3 -mtune=apple-m1 -moutline-atomics -O3 -flto=auto -ffast-math -funroll-loops -fomit-frame-pointer -DNDEBUG"
            CFLAGS: "-march=armv8.4-a+crypto+fp16+dotprod+rcpc+sha3 -mtune=apple-m1 -moutline-atomics -O3 -flto=auto -DNDEBUG"
          - arch: amd64
            runner: 'ubuntu-latest' 
            platform: amd64-linux
            DUCKDB_PLATFORM: linux_amd64
            CXXFLAGS: "-march=x86-64-v3 -mtune=generic -O3 -flto=auto -mavx -mavx2 -mfma -ffast-math -funroll-loops -fomit-frame-pointer -DNDEBUG"
            CFLAGS: "-march=x86-64-v3 -mtune=generic -O3 -flto=auto -DNDEBUG"
    
    runs-on: ${{ matrix.runner }}
    
    container:
      image: public.ecr.aws/amazonlinux/amazonlinux:2023
    
    steps:
      - name: Install basic tools
        run: |
          dnf update -y
          dnf install --allowerasing \
            tar gzip xz git cmake \
            gcc14 gcc14-c++ \
            make curl \
            openssl-devel zlib-devel libcurl-devel \
            python3 -y
      
      - name: Checkout repository
        uses: actions/checkout@v6
      
      - name: Set duckdb_version variable
        run: |
          echo "Setting DUCKDB_VER variable"
          source ./duckdb_version
          echo "DUCKDB_VER=$DUCKDB_VER" >> $GITHUB_ENV
      
      - name: Clone DuckDB
        run: |
          git clone --depth 1 --branch $DUCKDB_VER https://github.com/duckdb/duckdb.git
      
      - name: Build DuckDB bundle
        run: |
          pushd duckdb
          mkdir -p build/release/vcpkg_installed/${{ matrix.platform }}/lib

          export CC=/usr/bin/gcc14-gcc
          export CXX=/usr/bin/gcc14-g++

          echo "ðŸ“‹ Compiler version:"
          $CC --version | head -1

          export CXXFLAGS="${{ matrix.CXXFLAGS }}"
          export CFLAGS="${{ matrix.CFLAGS }}"
          DUCKDB_PLATFORM=${{ matrix.DUCKDB_PLATFORM }} \
          BUILD_SHELL=0 \
          DISABLE_EXTENSION_LOAD=1 \
          BUILD_EXTENSIONS="httpfs;parquet;json;icu;" \
          make bundle-library
          popd
      
      - name: Package library
        run: |
          pushd duckdb
          tar -cJf libduckdb_bundle-${{ matrix.arch }}.tar.xz -C ./build/release libduckdb_bundle.a
          popd
      
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: libduckdb-${{ matrix.arch }}
          path: duckdb/libduckdb_bundle-${{ matrix.arch }}.tar.xz
          retention-days: 1

  release:
    needs: build
    runs-on: ubuntu-latest
    if: github.ref_type == 'tag'
    
    steps:
      - name: Download ARM64 artifact
        uses: actions/download-artifact@v4
        with:
          pattern: libduckdb-*
          path: ./release
      
      - name: List files
        run: |
          echo "Files to be released:"
          ls -lh ./release/
      
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: ./release/*
          body: |
            Multi-architecture DuckDB bundle release. Built on Amazon Linux 2023.
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}