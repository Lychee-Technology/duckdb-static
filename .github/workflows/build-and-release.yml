name: Build DuckDB static bundle on Amazon Linux 2023

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    strategy:
      matrix:
        include:
          - arch: arm64
            runner: 'ubuntu-24.04-arm' 
            platform: arm64-linux
            build_extensions: 'httpfs;json;icu;parquet'
            flavor: 'httpfs-parquet'
          - arch: arm64
            runner: 'ubuntu-24.04-arm' 
            platform: arm64-linux
            build_extensions: 'httpfs;json;icu;vortex;'
            flavor: 'httpfs-vortex'
          - arch: arm64
            runner: 'ubuntu-24.04-arm' 
            platform: arm64-linux
            build_extensions: 'httpfs;json;icu;parquet;vortex;'
            flavor: 'httpfs-parquet-vortex'
          - arch: amd64
            runner: 'ubuntu-latest' 
            platform: amd64-linux
            build_extensions: 'httpfs;json;icu;parquet'
            flavor: 'httpfs-parquet'
          - arch: amd64
            runner: 'ubuntu-latest' 
            platform: amd64-linux
            build_extensions: 'httpfs;json;icu;vortex;'
            flavor: 'httpfs-vortex'
          - arch: amd64
            runner: 'ubuntu-latest' 
            platform: amd64-linux
            build_extensions: 'httpfs;json;icu;parquet;vortex;'
            flavor: 'httpfs-parquet-vortex'
    
    runs-on: ${{ matrix.runner }}
    
    container:
      image: public.ecr.aws/amazonlinux/amazonlinux:2023
    
    steps:
      - name: Install basic tools
        run: |
          dnf update -y
          dnf install --allowerasing \
            tar gzip xz git cmake \
            make gcc gcc-c++ curl patch \
            openssl-devel zlib-devel libcurl-devel \
            python3 -y
          
      - name: Install Rust toolchain
        run: |
          curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
          source "$HOME/.cargo/env"
          rustc --version
      
      - name: Checkout repository
        uses: actions/checkout@v6
      
      - name: Set duckdb_version variable
        run: |
          echo "Setting DUCKDB_VER variable"
          source ./duckdb_version
          echo "DUCKDB_VER=$DUCKDB_VER" >> $GITHUB_ENV
      
      - name: Clone DuckDB
        run: |
          git clone --depth 1 --branch $DUCKDB_VER https://github.com/duckdb/duckdb.git
      
      - name: Build DuckDB bundle
        run: |
          pushd duckdb
          mkdir -p build/release/vcpkg_installed/${{ matrix.platform }}/lib
          DUCKDB_PLATFORM=any \
          DISABLE_EXTENSION_LOAD=1 \
          BUILD_EXTENSIONS="${{ matrix.build_extensions }}" \
          make bundle-library
          popd
      
      - name: Package library
        run: |
          pushd duckdb
          tar -cJf libduckdb_bundle-${{ matrix.platform }}-${{ matrix.flavor }}.tar.xz -C ./build/release libduckdb_bundle.a
          popd
      
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: libduckdb-${{ matrix.arch }}-${{ matrix.flavor }}
          path: duckdb/libduckdb_bundle-${{ matrix.platform }}-${{ matrix.flavor }}.tar.xz
          retention-days: 1

  release:
    needs: build
    runs-on: ubuntu-latest
    if: github.ref_type == 'tag'
    
    steps:
      - name: Download ARM64 artifact
        uses: actions/download-artifact@v4
        with:
          name: libduckdb-arm64
          path: ./release
      
      - name: Download AMD64 artifact
        uses: actions/download-artifact@v4
        with:
          name: libduckdb-amd64
          path: ./release
      
      - name: List files
        run: |
          echo "Files to be released:"
          ls -lh ./release/
      
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: ./release/*
          body: |
            Multi-architecture DuckDB bundle release
            
            Architectures included:
            - ARM64 (aarch64)
            - AMD64 (x86_64)
            
            Built on Amazon Linux 2023
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}